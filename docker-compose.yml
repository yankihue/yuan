version: '3.9'

services:
  orchestrator:
    build:
      context: .
      target: orchestrator
    env_file:
      - .env
    environment:
      - ORCHESTRATOR_PORT=${ORCHESTRATOR_PORT:-3000}
      # Working directory for repo operations
      - WORKING_DIRECTORY=/app/workdir
      # GitHub credentials for git operations
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GH_TOKEN=${GITHUB_TOKEN}
      # Default GitHub org for repos without explicit org (e.g., "pastry" -> "yankihue/pastry")
      - GITHUB_ORG=${GITHUB_ORG:-yankihue}
      # Git identity for commits
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-Yuan Bot}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-yuan-bot@users.noreply.github.com}
      - GIT_COMMITTER_NAME=${GIT_AUTHOR_NAME:-Yuan Bot}
      - GIT_COMMITTER_EMAIL=${GIT_AUTHOR_EMAIL:-yuan-bot@users.noreply.github.com}
      # Limit Claude Code output tokens to prevent runaway responses
      - CLAUDECODEMAXOUTPUTTOKENS=${CLAUDECODEMAXOUTPUTTOKENS:-128000}
    ports:
      - "${ORCHESTRATOR_PORT:-3000}:3000"
    volumes:
      # Named volume for Claude credentials (run 'docker compose exec orchestrator claude login' to authenticate)
      - claude-credentials:/home/claude/.claude
    restart: unless-stopped

  telegram-bot:
    build:
      context: .
      target: telegram-bot
    env_file:
      - .env
    depends_on:
      - orchestrator
    environment:
      - ORCHESTRATOR_HOST=orchestrator
      - ORCHESTRATOR_PORT=${ORCHESTRATOR_PORT:-3000}
    restart: unless-stopped

  creative-agent:
    build:
      context: .
      target: creative-agent
    env_file:
      - .env
    depends_on:
      - orchestrator
    environment:
      - CREATIVE_AGENT_PORT=${CREATIVE_AGENT_PORT:-3003}
      - ORCHESTRATOR_URL=http://orchestrator:${ORCHESTRATOR_PORT:-3000}
      - ORCHESTRATOR_SECRET=${ORCHESTRATOR_SECRET}
      # Twitter API
      - TWITTER_BEARER_TOKEN=${TWITTER_BEARER_TOKEN}
      # GitHub API
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_USERNAME=${GITHUB_USERNAME}
      - GITHUB_IGNORE_REPOS=${GITHUB_IGNORE_REPOS:-yanki.dev,agentic-art}
      # Telegram
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      # Anthropic
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Schedule (optional)
      - CREATIVE_AGENT_CRON=${CREATIVE_AGENT_CRON:-0 */8 * * *}
      - CREATIVE_AGENT_USAGE_THRESHOLD=${CREATIVE_AGENT_USAGE_THRESHOLD:-50}
    ports:
      - "${CREATIVE_AGENT_PORT:-3003}:3003"
    restart: unless-stopped

volumes:
  claude-credentials:
